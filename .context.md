# Koinos Wallet — AI Agent Context File

> **Purpose:** This file provides comprehensive context for AI agents working on this codebase.
> It covers the software architecture, crypto polyfill system, build/compilation pipeline,
> known issues, and development workflow. Read this before making any changes.

---

## 1. Project Identity

| Field | Value |
|-------|-------|
| **Name** | Koinos Wallet |
| **Type** | Mobile cryptocurrency wallet for the Koinos blockchain |
| **Framework** | React Native 0.81.5 + Expo SDK 54 |
| **Language** | TypeScript (strict mode) |
| **Bundle ID** | `com.koinos.wallet` |
| **Entry Point** | `index.ts` → `App.tsx` |
| **Node** | 18+ LTS |
| **React** | 19.1.0 |
| **Target Platforms** | iOS (primary), Android (secondary), Web (experimental) |

---

## 2. Directory Structure

```
koinos-wallet/
├── index.ts                  # Entry point — polyfills + registerRootComponent
├── App.tsx                   # Navigation setup (React Navigation native stack)
├── app.json                  # Expo configuration (bundle ID, splash, icons)
├── package.json              # Dependencies and scripts
├── tsconfig.json             # TypeScript config (extends expo/tsconfig.base)
├── jest.setup.ts             # Test setup (AsyncStorage mock, jest-native matchers)
├── start-ios.sh              # Quick-start script for iOS Simulator (Expo Go)
├── .gitignore                # Ignores node_modules/, ios/, .expo/, dist/
├── CONTRIBUTING.md           # Git branching strategy and workflow
├── README.md                 # Setup, run, native build, and troubleshooting docs
│
├── src/
│   ├── screens/
│   │   ├── WelcomeScreen.tsx       # First-run: Create or Import wallet
│   │   ├── CreateWalletScreen.tsx  # BIP-39 mnemonic generation + display
│   │   ├── ImportWalletScreen.tsx  # Import via seed phrase or WIF key
│   │   ├── HomeScreen.tsx          # Main dashboard: balance, mana, actions
│   │   ├── SendScreen.tsx          # Send KOIN or VHP (token selector, address, amount)
│   │   ├── ReceiveScreen.tsx       # QR code + address copy
│   │   └── SettingsScreen.tsx      # RPC endpoint, seed phrase, delete wallet
│   │
│   ├── services/
│   │   ├── wallet.ts    # WalletService: create, import, load, delete, cache signer
│   │   └── koinos.ts    # KoinosService: balance, mana, sendKoin, sendVhp, RPC
│   │
│   ├── utils/
│   │   └── platform.ts  # Cross-platform helpers: showAlert, copyToClipboard
│   │
│   └── components/      # (empty — UI is currently inline in screens)
│
├── ios/                 # Generated native project (NOT committed — in .gitignore)
│   ├── KoinosWallet.xcodeproj/
│   ├── KoinosWallet.xcworkspace/
│   ├── KoinosWallet/
│   ├── Pods/
│   └── Podfile
│
├── assets/              # App icons, splash screens, screenshots
│   ├── icon.png
│   ├── splash-icon.png
│   ├── adaptive-icon.png
│   └── main_screen.png
│
└── __tests__/           # Unit and integration tests
```

### Key Insight: `ios/` is NOT committed
The `ios/` folder is in `.gitignore`. It's fully generated by `npx expo prebuild --platform ios --clean` from `app.json` config. **Never manually edit files in `ios/`** — they will be overwritten. If you need to change native project settings, do it via Expo config plugins in `app.json` or a custom config plugin.

---

## 3. Architecture Overview

### 3.1 Navigation Flow

```
App.tsx checks walletService.hasWallet()
  ├── No wallet  → WelcomeScreen → CreateWalletScreen / ImportWalletScreen → HomeScreen
  └── Has wallet → HomeScreen
                     ├── Send → SendScreen
                     ├── Receive → ReceiveScreen
                     └── Settings → SettingsScreen
```

Navigation uses `@react-navigation/native-stack` (native stack navigator). The initial route is determined asynchronously at app startup.

### 3.2 Service Layer

#### `WalletService` (src/services/wallet.ts)
- Singleton instance (`export default new WalletService()`)
- **Storage:** `expo-secure-store` on native, `localStorage` on web
- **Key derivation:** BIP-39 mnemonic → ethers.js HDNode → Koinos derivation path `m/44'/659'/{account}'/0/0` (coin type 659 = Koinos)
- **Signer:** `koilib.Signer` created from derived private key (compressed = true)
- **Caching:** `loadWallet()` caches the signer/address in memory after first derivation. This avoids re-deriving the HD key on every screen navigation.
- **Import formats:** BIP-39 mnemonic (12 words) or WIF private key
- **Storage format:** Raw mnemonic string, or `wif:<key>` prefixed string

#### `KoinosService` (src/services/koinos.ts)
- Singleton instance
- Uses `koilib` library (Provider, Contract, Signer, utils)
- **RPC endpoint:** Default `https://api.koinos.io`, user-configurable via Settings, persisted in AsyncStorage
- **KOIN contract:** `19GYjDBVXU7keLbYvMLazsGQn3GTWHjHkK` (8 decimals)
- **VHP contract:** `12Y5vW6gk8GceH53YfRkRre2Rrcsgw7Naq` (8 decimals)
- **Token ABI:** Inline protobuf-based ABI definition (balance_of, transfer, etc.)
- **Transactions:** `sendKoin()` / `sendVhp()` — creates contract call, submits, waits for mining confirmation
- **RC limit:** Hardcoded to `100000000` (1 KOIN worth of mana) per transaction

### 3.3 Token Types
| Token | Contract Address | Decimals | Description |
|-------|-----------------|----------|-------------|
| KOIN | `19GYjDBVXU7keLbYvMLazsGQn3GTWHjHkK` | 8 | Main Koinos token |
| VHP | `12Y5vW6gk8GceH53YfRkRre2Rrcsgw7Naq` | 8 | Virtual Hash Power (staking/mining) |

---

## 4. The Crypto Polyfill System (CRITICAL)

This is the most important architectural detail. **If you break this, transaction signing stops working.**

### 4.1 The Problem

The signing flow is:
```
koilib → @noble/secp256k1 v1.7.2 → crypto.subtle.importKey/sign/digest
```

`@noble/secp256k1` v1.7.2 performs HMAC-SHA256 for deterministic ECDSA (RFC 6979). It detects `self.crypto` and tries to use `crypto.subtle` for this. In React Native:
- `react-native-get-random-values` polyfills `self.crypto.getRandomValues` ✅
- But it does NOT provide `self.crypto.subtle` ❌
- So `self.crypto` exists, `secp256k1` detects it, but `crypto.subtle` is `undefined`
- Result: `TypeError: Cannot read property 'importKey' of undefined`

### 4.2 The Solution (in index.ts)

We polyfill `self.crypto.subtle` with a minimal implementation using `@noble/hashes` (pure JavaScript, no native dependencies):

```typescript
import { hmac } from '@noble/hashes/hmac';
import { sha256 } from '@noble/hashes/sha256';

if (typeof self !== 'undefined' && self.crypto && !self.crypto.subtle) {
  (self.crypto as any).subtle = {
    async digest(algorithm, data) {
      // SHA-256 only — used by secp256k1 for message hashing
      return sha256(new Uint8Array(data)).buffer as ArrayBuffer;
    },
    async importKey(_format, keyData, ...) {
      // Stores raw key bytes — secp256k1 passes HMAC key material here
      return { keyData: new Uint8Array(keyData) };
    },
    async sign(_algorithm, key, data) {
      // HMAC-SHA256 — the core operation secp256k1 needs for RFC 6979
      return hmac(sha256, key.keyData, new Uint8Array(data)).buffer as ArrayBuffer;
    },
  };
}
```

### 4.3 Why Other Approaches Failed

| Approach | Why It Failed |
|----------|--------------|
| `react-native-quick-crypto` | Requires NitroModules native build; crashes in Expo Go; was removed |
| `expo-crypto` | Provides `digestStringAsync` but not the `SubtleCrypto` interface that secp256k1 expects |
| Override `secp.utils.hmacSha256Sync` | Metro bundles ESM and CJS as separate module instances. The secp256k1 instance that koilib imports is NOT the same one you import directly. Your override never reaches the actual instance used for signing. |
| `@noble/secp256k1` v2.x | Breaking API changes, not compatible with koilib v9.2.0 |

### 4.4 Polyfill Load Order (index.ts)

The order of imports in `index.ts` is **critical** and must not be changed:

```
1. react-native-get-random-values  → adds self.crypto.getRandomValues
2. @ethersproject/shims             → process, nextTick polyfills
3. buffer                           → global Buffer
4. @noble/hashes/hmac + sha256      → used to build subtle polyfill
5. crypto.subtle polyfill           → patches self.crypto.subtle
6. expo registerRootComponent       → starts the app (any koilib import after this point sees subtle)
```

**Rule:** NEVER import koilib or any module that transitively imports `@noble/secp256k1` before the polyfill is applied. The polyfill must run before any crypto library tries to detect `crypto.subtle`.

---

## 5. Build & Compilation Pipeline

### 5.1 Development Modes

There are **three** ways to run the app:

#### Mode A: Expo Go (Simulator — fastest iteration)
```bash
./start-ios.sh
# or: npx expo start --ios --localhost --go
```
- Uses the pre-built Expo Go app on the iOS Simulator
- No native compilation needed
- Limited to APIs included in Expo Go
- Cannot use custom native modules
- **Use for:** UI development, testing JS logic

#### Mode B: Expo Go (Physical Device)
```bash
npx expo start --go
```
- Install Expo Go from the App Store
- Scan QR code with iPhone camera
- Same limitations as Mode A
- **Use for:** Quick testing on real hardware

#### Mode C: Native Build (Physical Device — full capability)
```bash
npx expo prebuild --platform ios --clean
npx expo run:ios --device
```
- Compiles a real native binary with Xcode
- Full access to all native modules
- Required for production / App Store builds
- **Use for:** Final testing, production deployment

### 5.2 Native Build Process (Detailed)

#### Step 1: Generate native project
```bash
npx expo prebuild --platform ios --clean
```
This generates the `ios/` directory from `app.json`:
- Creates `KoinosWallet.xcodeproj` and `KoinosWallet.xcworkspace`
- Generates `Podfile` from Expo dependencies
- Runs `pod install` to fetch CocoaPods dependencies
- Configures signing, bundle ID, splash screen, etc.

The `--clean` flag deletes and regenerates from scratch. Use it when:
- You changed `app.json` (bundle ID, permissions, plugins)
- You added/removed native dependencies in `package.json`
- The build is broken and you want a clean slate

#### Step 2: Build and install
```bash
npx expo run:ios --device
```
Under the hood, this runs:
1. `xcodebuild` to compile all native code:
   - Hermes JavaScript engine (C++)
   - React Native bridge (Obj-C/C++)
   - All CocoaPods dependencies (native modules)
   - The KoinosWallet app target
2. Code signing with your Apple Developer certificate
3. `xcrun devicectl` to install the `.app` on the connected iPhone
4. Launches the app on the device

#### Step 3: Start Metro bundler
```bash
npx expo start --dev-client
```
The native app loads the JavaScript bundle from Metro over the network:
- Metro serves on port 8081
- The dev client discovers the server via Bonjour/mDNS on the local network
- If auto-discovery fails, manually enter: `http://<MAC_IP>:8081`
- Find Mac IP: `ipconfig getifaddr en0`

#### Production Build (embedded JS, no Metro needed)
```bash
npx expo run:ios --device --configuration Release
```
This embeds the JS bundle inside the binary — the app runs standalone.

### 5.3 Known Build Issues & Solutions

#### Sandbox Permission Denial
```
Sandbox: bash deny(1) file-write-create .../KoinosWallet.app/ip.txt
```
**Cause:** Xcode's `ENABLE_USER_SCRIPT_SANDBOXING = YES` blocks React Native's "Bundle React Native code and images" build phase from writing files.
**Fix:** In `ios/KoinosWallet.xcodeproj/project.pbxproj`, change both occurrences:
```
ENABLE_USER_SCRIPT_SANDBOXING = NO;
```
Then clean DerivedData: `rm -rf ~/Library/Developer/Xcode/DerivedData/KoinosWallet-*`
**Note:** Since `ios/` is regenerated by prebuild, you may need to re-apply this fix after each `prebuild --clean`. Consider adding an Expo config plugin to automate it.

#### Device Name Regex Bug
If the iPhone name contains special regex characters (apostrophe, parenthesis), Expo CLI crashes:
```
Invalid regular expression: /Pablos iPhone 17 (/i: Unterminated group
```
**Fix:** Pass the device UDID directly:
```bash
xcrun devicectl list devices   # Find the device ID
npx expo run:ios --device <DEVICE_ID>
```

#### "Profile has not been explicitly trusted by the user"
**Cause:** Free Apple Developer accounts require manual trust on first install.
**Fix:** On iPhone → Settings → General → VPN & Device Management → Trust your developer profile.

#### "No development servers found" (Dev Client)
**Cause:** The native app can't find the Metro bundler.
**Fix:** Start Metro with `npx expo start --dev-client`, then in the app enter `http://<MAC_IP>:8081` manually.

#### Disk Space Issues
Native builds require ~5GB+ of disk space for DerivedData. Clean with:
```bash
rm -rf ~/Library/Developer/Xcode/DerivedData/*
rm -rf ~/Library/Developer/CoreSimulator/Caches/*
xcrun simctl delete unavailable
```

---

## 6. Key Dependencies & Their Roles

| Package | Version | Role | Notes |
|---------|---------|------|-------|
| `koilib` | ^9.2.0 | Koinos blockchain SDK (Provider, Contract, Signer, utils) | Depends on @noble/secp256k1 v1.7.2 |
| `@noble/secp256k1` | 1.7.2 | ECDSA signing (secp256k1 curve) | Transitive via koilib — uses crypto.subtle |
| `@noble/hashes` | (transitive) | SHA-256, HMAC — used in our crypto.subtle polyfill | Pure JS, no native deps |
| `ethers` | ^5.8.0 | HD wallet derivation (HDNode.fromMnemonic) | Only v5 — NOT ethers v6 |
| `@ethersproject/shims` | ^5.8.0 | process/nextTick polyfills for ethers in React Native | Must load before ethers |
| `bip39` | ^3.1.0 | BIP-39 mnemonic generation and validation | 12-word English wordlist |
| `react-native-get-random-values` | ~1.11.0 | Polyfills crypto.getRandomValues for React Native | MUST be first import in index.ts |
| `expo-secure-store` | ^15.0.8 | Encrypted key storage (Keychain on iOS) | Stores mnemonic/WIF |
| `@react-native-async-storage/async-storage` | ^2.2.0 | General persistent storage | Stores RPC URL preference |
| `react-native-qrcode-svg` | ^6.3.21 | QR code generation for receive screen | Depends on react-native-svg |
| `expo-clipboard` | ~8.0.8 | System clipboard access | Copy address, paste address |
| `expo-camera` | ~17.0.10 | Camera access for QR scanning | (Planned — not yet used) |
| `buffer` | ^6.0.3 | Node.js Buffer polyfill for React Native | Required by koilib/ethers |

### Removed Packages (DO NOT RE-ADD)
| Package | Why Removed |
|---------|------------|
| `react-native-quick-crypto` | Crashes in Expo Go (requires NitroModules native build). Incompatible with the Expo managed workflow. Our pure-JS polyfill replaces it. |
| `expo-crypto` | Does not provide SubtleCrypto interface. Only offers `digestStringAsync`. Not useful for secp256k1's needs. |
| `expo-dev-client` | Was removed from package.json dependencies (Expo SDK 54 includes it automatically). |

---

## 7. Testing

### 7.1 Test Setup
- **Framework:** Jest 29 + jest-expo preset
- **Utilities:** @testing-library/react-native + @testing-library/jest-native
- **Mocks:** AsyncStorage is mocked via its official jest mock
- **Config:** jest.setup.ts, transformIgnorePatterns in package.json

### 7.2 Running Tests
```bash
# Unit tests (64 tests, mocked blockchain)
npm test

# Integration tests (real blockchain — requires network)
npm run test:integration
```

### 7.3 Test Files
Tests are located in `__tests__/` directory (following jest-expo convention). All 64 unit tests pass as of the current commit.

---

## 8. Git Workflow

### Branches
| Branch | Purpose |
|--------|---------|
| `main` | Production-ready code. Every commit is a potential release. |
| `develop` | Integration branch. Features merged here for testing. |
| `feature/*` | Short-lived feature branches off `develop` |
| `fix/*` | Short-lived bug fix branches off `develop` |

### Current State
- `main`: Stable, has crypto.subtle polyfill
- `develop`: Has all features (comma fix, wallet caching, --go flag)
- `feature/native-ios-build`: Active — native build + README updates

### Commit Convention
Prefixes: `feat:`, `fix:`, `refactor:`, `test:`, `docs:`, `chore:`

See [CONTRIBUTING.md](CONTRIBUTING.md) for the full workflow.

---

## 9. Environment & Tooling

### Development Machine
- macOS (Mac mini or MacBook)
- Xcode with Command Line Tools
- CocoaPods (for iOS native dependencies)
- Node.js 18+ LTS

### Apple Signing
- Free Apple Developer account works for personal testing
- Apps signed with free account expire after 7 days
- Paid account ($99/year) required for App Store distribution
- The build auto-selects the signing team from available certificates

### Important Paths
| Path | Description |
|------|-------------|
| `~/Library/Developer/Xcode/DerivedData/` | Xcode build cache — can grow to 10GB+ |
| `~/Library/Developer/CoreSimulator/` | Simulator data and caches |
| `ios/KoinosWallet.xcworkspace` | Open this (not .xcodeproj) in Xcode for manual work |

---

## 10. Common Tasks for AI Agents

### Adding a New Screen
1. Create `src/screens/NewScreen.tsx`
2. Add route type to `RootStackParamList` in `App.tsx`
3. Add `<Stack.Screen>` in `App.tsx`
4. Navigate with `navigation.navigate('NewScreen')`

### Adding a New Token
1. Add contract address constant in `src/services/koinos.ts`
2. Add balance fetch method (reuse existing `tokenAbi` — KRC-20 standard)
3. Add send method following `sendKoin`/`sendVhp` pattern
4. Update `SendScreen.tsx` token selector
5. Update `HomeScreen.tsx` balance display

### Modifying Native iOS Configuration
**DO NOT** edit files in `ios/` directly. Instead:
1. Change `app.json` for standard Expo config
2. For advanced settings, create an Expo config plugin
3. Run `npx expo prebuild --platform ios --clean` to regenerate

### Updating Dependencies
```bash
npx expo install <package>     # Use this for Expo-compatible versions
npm install <package>           # For non-Expo packages
npx expo prebuild --clean       # Regenerate native project if native deps changed
```

---

## 11. Wallet Derivation Details

For reference and debugging:

| Field | Value |
|-------|-------|
| **BIP-44 Path** | `m/44'/659'/0'/0/0` |
| **Coin Type** | 659 (Koinos) |
| **Key Compression** | `compressed: true` (IMPORTANT — wrong compression = wrong address) |
| **Address Format** | Base58 (Bitcoin-style), 26-35 characters |
| **Compatible With** | Kondor browser wallet (same derivation path) |
| **Test Address** | `17Gvjva6PE4ApYSNiQEvDi8jYeuebGRnnL` |

---

## 12. Decimal / Locale Handling

Some locales use comma as decimal separator (e.g., Spanish: `0,120` instead of `0.120`). JavaScript's `parseFloat("0,120")` returns `NaN`. 

**Fix applied in SendScreen.tsx:** All amount inputs are normalized with `.replace(',', '.')` before:
1. Validation (`parseFloat`)
2. Confirmation dialog display
3. Passing to `koinosService.sendKoin()`/`sendVhp()`

If adding new numeric inputs, always normalize commas to dots before parsing.

---

## 13. Runtime Warnings (Safe to Ignore)

These appear in the Metro console and are harmless:

1. **`@noble/hashes/crypto.js` not listed in "exports"**
   - Metro falls back to file-based resolution. The import works fine.

2. **`SafeAreaView has been deprecated`**
   - From React Native core. Plan to migrate to `react-native-safe-area-context`.

3. **`Unexpected devicectl JSON version output`**
   - Xcode/devicectl version mismatch warning. Device deployment still works.

---

## 14. Security Considerations

- **Mnemonic/WIF** stored in `expo-secure-store` (iOS Keychain, Android Keystore)
- **Private key** only exists in memory as a `Signer` instance — never logged or transmitted
- The `signer` is cached in the `WalletService` singleton for the session lifetime
- **RPC URL** stored in `AsyncStorage` (not sensitive)
- **No analytics, no telemetry, no remote logging** — fully local wallet
